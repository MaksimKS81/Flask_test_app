<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Home</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        html, body {
          height: 100%;
          margin: 0;
          display: flex;
          flex-direction: column;
        }
        /* Container for main content + sidebar */
        .container {
          flex: 1;           /* take up all available space */
          display: flex;
        }
        /* Main chart area */
        .main-content {
          flex: 1;
          padding: 20px;
          overflow: auto;
        }
        /* Sidebar info box */
        .info-box {
          width: 300px;
          margin: 20px;
          border: 1px solid #ccc;
          display: flex;
          flex-direction: column;
          height: 50vh;        /* limit vertical size to half the viewport */
        }
        .info-header {
          background-color: #4CAF50;   /* green */
          color: white;
          padding: 10px;
          font-weight: bold;
        }
        .info-body {
          flex: 1;
          padding: 10px;
          overflow: auto;
        }
        .info-footer {
          background-color: #f44336;   /* red */
          color: white;
          padding: 10px;
          text-align: center;
        }
        /* page footer */
        .page-footer {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          background: #333;
          color: #fff;
          text-align: center;
          padding: 8px 0;
          font-size: 0.9em;
        }

        #charts-container {
            display: flex;
            justify-content: space-between;
        }
        .chart {
            width: 45%;
        }
        
        /* Bar charts container */
        #bar-charts-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }
        .bar-chart {
            width: 45%;
        }
    </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <h1>Prototype system for visual tracking of rehabilitation progress after ACL reconstruction surgery.</h1>

      <!-- Dropdown for chart 1 -->
      <div>
          <label for="dropdownTimeCohort">Select time for the cohort:</label>
          <select id="dropdownTimeCohort"></select>
      </div>

      <!-- Dropdown for chart 1 -->
      <div>
          <label for="dropdownTime">Select time for the test subject:</label>
          <select id="dropdownTime"></select>
      </div>

      <!-- Dropdown for chart 2 -->
      <div>
          <label for="dropdownEXE">Select Exe type:</label>
          <select id="dropdownEXE"></select>
      </div>

      <!-- 3rd Dropdown for UID -->
      <div>
          <label for="dropdownUID">Select UID:</label>
          <select id="dropdownUID"></select>
      </div>

      <!-- 4th Dropdown for Display Mode -->
      <div>
          <label for="dropdownDisplayMode">Chart 2 Display Mode:</label>
          <select id="dropdownDisplayMode">
              <option value="absolute">Absolute Values</option>
              <option value="zscore">Z-Score</option>
          </select>
      </div>

      <!-- Chart divs -->
      <div id="charts-container">
          <div id="chart1" class="chart"></div>
          <div id="chart2" class="chart"></div>
      </div>
      
      <!-- Bar Chart divs -->
      <div id="bar-charts-container">
          <div id="bar-chart1" class="bar-chart"></div>
          <div id="bar-chart2" class="bar-chart"></div>
      </div>
    </div>

    <div class="info-box">
      <div class="info-header">Description</div>
      <div class="info-body">
        <p>
          This dashboard shows mobility and alignment metrics over time. 
          Select a test type and time point to update the charts.
        </p>
        <h3>Chart Types</h3>
        <ul>
          <li><strong>Spider/Radar Charts (Top):</strong> Show multi-dimensional comparison across all metrics at once</li>
          <li><strong>Bar Charts (Bottom):</strong> Alternative view of the same data for easier metric-by-metric comparison</li>
        </ul>
        <h3>Data Preprocessing</h3>
        <ol>
          <li>Filter out values below the 5th and above the 95th percentile.</li>
          <li>Compute the 50th percentile (median) for visual representation.</li>
          <li>Normalize each metric by scaling to the 5th–95th percentile range.</li>
        </ol>
        <p>
          Note: Some records contain missing or incorrect data and are excluded or imputed as needed.
        </p>
      </div>
      <div class="info-footer">
          Need help? <a href="mailto:mkrivolapov@darimotion.com" style="color:#fff; text-decoration:underline;">
          Contact support</a>
      </div>
    </div>
  </div>

  <!-- Page‐level footer always visible -->
  <footer class="page-footer">
    © 2025 ACL visualization v. 1.0.2
  </footer>

  <script>
const dropdownTimeCohort = document.getElementById("dropdownTimeCohort");
const dropdownTime = document.getElementById("dropdownTime");
const dropdownEXE = document.getElementById("dropdownEXE");
const dropdownUID = document.getElementById("dropdownUID");
const dropdownDisplayMode = document.getElementById("dropdownDisplayMode");

// Function to fetch data and update charts
function updateCharts() {
  const option1 = dropdownTimeCohort.value;
  const Time = dropdownTime.value;
  const exeType = dropdownEXE.value;
  const uid = dropdownUID.value; // Get the selected UID

  // Build the query string dynamically
  const displayMode = dropdownDisplayMode.value;
  const queryString = `?dropdownTimeCohort=${encodeURIComponent(option1)}&optionTime=${encodeURIComponent(Time)}&EXE=${encodeURIComponent(exeType)}&uid=${encodeURIComponent(uid)}&displayMode=${encodeURIComponent(displayMode)}`;

  // Fetch data with the selected options
  fetch("/get_chart_data" + queryString)
    .then(resp => resp.json())
    .then(data => {
      console.log("[DEBUG] Received data:", data);
      console.log("[DEBUG] chart1 has bar_chart:", data.chart1.bar_chart !== undefined);
      console.log("[DEBUG] chart2 has bar_chart:", data.chart2.bar_chart !== undefined);
      
      // Update the spider charts
      Plotly.newPlot("chart1", data.chart1.traces, data.chart1.layout);
      Plotly.newPlot("chart2", data.chart2.traces, data.chart2.layout);
      
      // Update the bar charts
      if (data.chart1.bar_chart) {
        console.log("[DEBUG] Plotting bar-chart1");
        Plotly.newPlot("bar-chart1", data.chart1.bar_chart.traces, data.chart1.bar_chart.layout);
      } else {
        console.warn("[WARN] chart1.bar_chart is missing");
      }
      if (data.chart2.bar_chart) {
        console.log("[DEBUG] Plotting bar-chart2");
        Plotly.newPlot("bar-chart2", data.chart2.bar_chart.traces, data.chart2.bar_chart.layout);
      } else {
        console.warn("[WARN] chart2.bar_chart is missing");
      }
    })
    .catch(err => console.error(err));
}

// Initial population of dropdowns and charts
fetch("/get_chart_data?option1=Option+1&option2=Option+2&time=9%20Month")
  .then(resp => resp.json())
  .then(data => {
    // Populate BOTH dropdown1 and dropdown2 with timePoints
    data.timePoints.forEach(timePoint => {
      const optionEl1 = document.createElement("option");
      optionEl1.value = timePoint;
      optionEl1.textContent = timePoint;
      dropdownTimeCohort.appendChild(optionEl1);

      const optionEl2 = document.createElement("option");
      optionEl2.value = timePoint;
      optionEl2.textContent = timePoint;
      dropdownTime.appendChild(optionEl2); 

    });

      // Populate EXE dropdown
    data.exe_type.forEach(exe => {
      const optionEXE = document.createElement("option");
      optionEXE.value = exe;
      optionEXE.textContent = exe;
      dropdownEXE.appendChild(optionEXE);
    });

    // Populate UID dropdown
    data.UID_list.forEach(uid => {
      const optionUID = document.createElement("option");
      optionUID.value = uid;
      optionUID.textContent = uid;
      dropdownUID.appendChild(optionUID);
    });

    // Set default values for dropdowns
    dropdownTimeCohort.value = "6 Month";
    dropdownTime.value = "6 Month"; // Default to the first timePoint
    dropdownEXE.value = "unilateral_squat";
    dropdownUID.value = data.UID_list[0];

    console.log("[DEBUG] Initial data:", data);
    console.log("[DEBUG] chart1 has bar_chart:", data.chart1.bar_chart !== undefined);
    console.log("[DEBUG] chart2 has bar_chart:", data.chart2.bar_chart !== undefined);

    // Render the initial charts
    Plotly.newPlot('chart1', data.chart1.traces, data.chart1.layout);
    Plotly.newPlot('chart2', data.chart2.traces, data.chart2.layout);
    
    // Render the initial bar charts
    if (data.chart1.bar_chart) {
      console.log("[DEBUG] Plotting initial bar-chart1");
      Plotly.newPlot('bar-chart1', data.chart1.bar_chart.traces, data.chart1.bar_chart.layout);
    } else {
      console.warn("[WARN] Initial chart1.bar_chart is missing");
    }
    if (data.chart2.bar_chart) {
      console.log("[DEBUG] Plotting initial bar-chart2");
      Plotly.newPlot('bar-chart2', data.chart2.bar_chart.traces, data.chart2.bar_chart.layout);
    } else {
      console.warn("[WARN] Initial chart2.bar_chart is missing");
    }
  })
  .catch(err => console.error(err));

// Add event listeners to update charts when dropdowns change
dropdownTimeCohort.addEventListener("change", updateCharts);
dropdownTime.addEventListener("change", updateCharts);
dropdownEXE.addEventListener("change", updateCharts);
dropdownUID.addEventListener("change", updateCharts);
dropdownDisplayMode.addEventListener("change", updateCharts);
</script>
</body>
</html>